# git.yaml - Enhanced git workflow with validation  
# Usage: ry libraries/git/git.yaml <command> [args...]

match:
  diff:
    # Show diff and generate token if --staged
    - shell: git diff {{args.rest|--staged}}
    - python: |
        import sys
        import pathlib
        
        # Only generate token for staged diffs
        args = "{{args.rest|--staged}}"
        if "--staged" in args or "--cached" in args:
            lib_path = pathlib.Path('libraries/git/lib').resolve()
            sys.path.insert(0, str(lib_path))
            from token import get_current_token
            
            token, expires = get_current_token()
            if token:
                print(f"\nREVIEW_TOKEN={token}", file=sys.stderr)
                print(f"# Expires in {expires} seconds", file=sys.stderr)
  
  commit:
    # Check review token - use !env to get it at YAML parse time
    - python: |
        import sys
        import pathlib
        
        # Token passed from environment at ry invocation time
        token = "{{env.REVIEW_TOKEN|}}"
        
        if not token:
            print("FAIL: review staged changes first", file=sys.stderr)
            print("  Run: ry git.yaml diff --staged", file=sys.stderr) 
            print("  Then: REVIEW_TOKEN=<token> ry git.yaml commit 'message'", file=sys.stderr)
            sys.exit(1)
        
        lib_path = pathlib.Path('libraries/git/lib').resolve()
        sys.path.insert(0, str(lib_path))
        from token import verify_token
        
        if not verify_token(token):
            print("FAIL: invalid or expired token", file=sys.stderr)
            print("  Run: ry git.yaml diff --staged (get fresh token)", file=sys.stderr)
            sys.exit(1)
    
    # Validate and clean commit message
    - python: |
        import sys
        import subprocess
        import os
        
        # Get commit message from args
        msg = "{{args.1|}}"
        if not msg:
            print("FAIL: no commit message provided", file=sys.stderr)
            print("  Usage: ry git.yaml commit 'message'", file=sys.stderr)
            sys.exit(1)
        
        # Import our validators
        import pathlib
        lib_path = pathlib.Path('libraries/git/lib').resolve()
        sys.path.insert(0, str(lib_path))
        from strip_claude import strip_signatures
        from validate_commit import validate_conventional
        
        # Clean the message
        cleaned = strip_signatures(msg)
        if cleaned != msg:
            print("WARN: removed AI signatures from commit message", file=sys.stderr)
        
        # Validate format
        is_valid, error = validate_conventional(cleaned)
        if not is_valid:
            print(f"FAIL: {error}", file=sys.stderr)
            print("  Example: feat: add new feature", file=sys.stderr)
            print("  Example: fix(api): handle null response", file=sys.stderr)
            sys.exit(1)
        
        # Output cleaned message
        print(cleaned)
      capture: CLEAN_MSG
    
    # Commit with cleaned message
    - shell: git commit -m "$CLEAN_MSG"
  
  add:
    - shell: git add {{args.rest}}
    - shell: |
        if [ -n "$(git diff --staged --name-only)" ]; then
            echo "Files staged. Next: ry git.yaml commit 'message'" >&2
        fi
  
  status:
    - shell: git status {{args.rest|}}
  
  push:
    # Check if on main/master
    - shell: |
        BRANCH=$(git branch --show-current)
        if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
            echo "FAIL: direct push to $BRANCH blocked" >&2
            echo "  Run: git checkout -b feature/name" >&2
            echo "  Run: git push -u origin feature/name" >&2
            exit 1
        fi
    - shell: git push {{args.rest|}}
  
  # Pass through everything else
  default:
    - shell: git {{args.all}}