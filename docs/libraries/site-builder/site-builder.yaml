# site-builder - Static site generator for project registries
# Generates beautiful GitHub Pages sites from registry.json or packages.json
#
# Library script execution:
# - $RY_LIBRARY_DIR is automatically exported when running libraries
# - Use it to reference library files: python $RY_LIBRARY_DIR/lib/script.py

match:
  init:
    - shell: |
        if [ -f "site.yaml" ]; then
          echo "ERROR: site.yaml already exists" >&2
          exit 1
        fi
        
        # Detect project type
        PROJECT_NAME=$(basename "$PWD")
        if [ -f "registry.json" ] || [ -f "docs/registry.json" ]; then
          ICON="🚀"
          ITEM_TYPE="library"
        elif [ -f "packages.json" ]; then
          ICON="📦"  
          ITEM_TYPE="package"
        else
          ICON="📁"
          ITEM_TYPE="item"
        fi
        
        # Find registry file
        REGISTRY=$(find . -name "registry.json" -o -name "packages.json" 2>/dev/null | head -1 | sed 's|^\./||')
        [ -z "$REGISTRY" ] && REGISTRY="registry.json"
        
        # Create site.yaml
        cat > site.yaml << EOF
        # Site configuration for ${PROJECT_NAME}
        project: ${PROJECT_NAME}
        title: ${PROJECT_NAME}
        icon: "${ICON}"
        description: "Project registry and documentation"
        
        # Registry location
        registry: "${REGISTRY}"
        item_type: ${ITEM_TYPE}
        
        # Installation methods
        setup:
          - name: uv
            command: "uv tool install ${PROJECT_NAME}"
            default: true
          - name: pipx
            command: "pipx install ${PROJECT_NAME}"
          - name: pip
            command: "pip install ${PROJECT_NAME}"
        
        # Repository
        repo: "https://github.com/angelsen/${PROJECT_NAME}"
        EOF
        
        echo "SUCCESS: Created site.yaml" >&2
        echo "INFO: Edit site.yaml to customize your site" >&2
  
  build:
    - shell: |
        if [ ! -f "site.yaml" ]; then
          echo "ERROR: site.yaml not found" >&2
          echo "  Run: ry site-builder init" >&2
          exit 1
        fi
    
    - shell: "python $RY_LIBRARY_DIR/lib/build.py"
    - shell: 'echo "SUCCESS: Generated docs/index.html" >&2'
  
  preview:
    - shell: |
        if [ ! -f "site.yaml" ]; then
          echo "ERROR: site.yaml not found" >&2
          echo "  Run: ry site-builder init" >&2
          exit 1
        fi
    - match: build
    - shell: |
        if command -v python3 >/dev/null; then
          echo "INFO: Serving at http://localhost:8000" >&2
          echo "INFO: Press Ctrl+C to stop" >&2
          cd docs && python3 -m http.server
        else
          echo "ERROR: Python3 not found - cannot start preview server" >&2
          exit 1
        fi
  
  clean:
    - shell: |
        if [ -f "docs/index.html" ]; then
          rm docs/index.html
          echo "SUCCESS: Removed docs/index.html" >&2
        else
          echo "INFO: No index.html to clean" >&2
        fi
  
  default:
    - shell: |
        echo "Usage: ry site-builder <command>" >&2
        echo "" >&2
        echo "Commands:" >&2
        echo "  init     - Create site.yaml configuration" >&2
        echo "  build    - Generate docs/index.html from registry" >&2
        echo "  preview  - Build and serve locally at :8000" >&2
        echo "  clean    - Remove generated files" >&2